/**
 * CVE Analyzer
 * CVE 취약점 검증 (Exact vs Fuzzy 구분)
 */

import { runAIAnalysis, parseAIResponse } from './ai-helper';
import type { CVEAnalysisResult } from './types';
import type { FilteredData } from '../ai-data-filter';

const SYSTEM_PROMPT = `You are a vulnerability assessment analyst.
Evaluate CVE matches and determine which are actual vulnerabilities for these endpoints.
Fuzzy matches have lower confidence - verify carefully.
Respond ONLY with valid JSON.`;

export async function analyzeCVEs(
  data: FilteredData['cve_analysis']
): Promise<CVEAnalysisResult> {
  const startTime = Date.now();

  try {
    const userPrompt = `
Incident: ${data.incident_id}
Total CVEs: ${data.total_cves}

Exact Match CVEs (High Confidence):
${JSON.stringify(data.exact_match_cves, null, 2)}

Fuzzy Match CVEs (Low Confidence - Verify!):
${JSON.stringify(data.fuzzy_match_cves, null, 2)}

Which CVEs are actual vulnerabilities? Which fuzzy matches are false positives?

Respond with JSON:
{
  "verified_cves": number,
  "false_positives": number,
  "critical_vulnerabilities": ["CVE-XXXX-XXXXX", "CVE-YYYY-YYYYY"],
  "confidence": 0.0-1.0,
  "risk_score": 0-10,
  "key_findings": ["finding1", "finding2"],
  "reasoning": "brief explanation (max 150 words)"
}`;

    const { text, tokens_used, execution_time_ms } = await runAIAnalysis(
      SYSTEM_PROMPT,
      userPrompt,
      { maxTokens: 700 }
    );

    const parsed = parseAIResponse<{
      verified_cves: number;
      false_positives: number;
      critical_vulnerabilities: string[];
      confidence: number;
      risk_score: number;
      key_findings: string[];
      reasoning: string;
    }>(text);

    return {
      category: 'cve_vulnerabilities',
      success: true,
      verified_cves: parsed.verified_cves,
      false_positives: parsed.false_positives,
      critical_vulnerabilities: parsed.critical_vulnerabilities,
      confidence: parsed.confidence,
      risk_score: parsed.risk_score,
      key_findings: parsed.key_findings,
      reasoning: parsed.reasoning,
      tokens_used,
      execution_time_ms,
    };
  } catch (error) {
    console.error('[CVE Analyzer] Error:', error);
    return {
      category: 'cve_vulnerabilities',
      success: false,
      verified_cves: data.exact_match_cves.length,
      false_positives: data.fuzzy_match_cves.length,
      critical_vulnerabilities: [],
      confidence: 0,
      risk_score: 5,
      key_findings: [],
      reasoning: 'Analysis failed',
      execution_time_ms: Date.now() - startTime,
      error: error instanceof Error ? error.message : String(error),
    };
  }
}
